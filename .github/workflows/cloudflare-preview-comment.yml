name: Post Cloudflare Pages Preview URL

on:
  pull_request:
    paths:
      - "website/**"
      - ".github/workflows/cloudflare-preview-comment.yml"
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  post-preview-url:
    runs-on: ubuntu-latest
    if: github.event.pull_request

    steps:
      - name: Wait for Cloudflare Pages deployment
        run: |
          echo "Cloudflare Pagesã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå®Œäº†ã‚’å¾…æ©Ÿä¸­..."
          sleep 90

      - name: Get Cloudflare Pages deployment info
        id: get-deployment
        uses: actions/github-script@v7
        with:
          script: |
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha
            });

            const cloudflareCheck = checks.check_runs.find(
              check => check.name === 'Cloudflare Pages'
            );

            if (!cloudflareCheck) {
              console.log('Cloudflare Pagesã®ãƒã‚§ãƒƒã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
              return {};
            }

            console.log('Cloudflare Pages check:', cloudflareCheck);

            const dashboardUrl = cloudflareCheck.details_url;
            let deploymentId = '';
            let previewUrl = '';

            // URLã‹ã‚‰ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆIDã‚’æŠ½å‡º
            const idMatch = dashboardUrl.match(/([0-9a-f]{8})-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/);
            if (idMatch) {
              deploymentId = idMatch[1];
              previewUrl = `https://${deploymentId}.sagebase-k37.pages.dev`;
            } else {
              // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ–ãƒ©ãƒ³ãƒåã‹ã‚‰ç”Ÿæˆ
              const branchName = context.payload.pull_request.head.ref;
              // ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’ãƒã‚¤ãƒ•ãƒ³ã«å¤‰æ›ã—ã€29æ–‡å­—ã«åˆ‡ã‚Šè©°ã‚
              const aliasName = branchName.replace(/\//g, '-').substring(0, 29);
              previewUrl = `https://${aliasName}.sagebase-k37.pages.dev`;
              console.log(`âš ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆIDã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¨ã‚¤ãƒªã‚¢ã‚¹URLã‚’ä½¿ç”¨ã—ã¾ã™: ${previewUrl}`);
            }

            core.setOutput('preview_url', previewUrl);
            core.setOutput('dashboard_url', dashboardUrl);
            core.setOutput('deployment_id', deploymentId);
            core.setOutput('status', cloudflareCheck.conclusion || cloudflareCheck.status);

            return {
              previewUrl,
              dashboardUrl,
              deploymentId,
              status: cloudflareCheck.conclusion || cloudflareCheck.status
            };

      - name: Comment on PR
        uses: actions/github-script@v7
        if: steps.get-deployment.outputs.preview_url
        with:
          script: |
            const previewUrl = '${{ steps.get-deployment.outputs.preview_url }}';
            const dashboardUrl = '${{ steps.get-deployment.outputs.dashboard_url }}';
            const deploymentId = '${{ steps.get-deployment.outputs.deployment_id }}';
            const status = '${{ steps.get-deployment.outputs.status }}';

            let comment = `## ğŸš€ Cloudflare Pages ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒ\n\n`;

            if (status === 'success') {
              comment += `âœ… **ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆåŠŸ**\n\n`;
              comment += `**ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URL**: ${previewUrl}\n\n`;
              if (deploymentId) {
                comment += `**ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆID**: \`${deploymentId}\`\n\n`;
              }
              comment += `ğŸ“Š [Cloudflare Pagesãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§è©³ç´°ã‚’ç¢ºèª](${dashboardUrl})\n\n`;
              comment += `---\n\n`;
              comment += `ğŸ’¡ **ãƒ’ãƒ³ãƒˆ**: ãƒ–ãƒ©ãƒ³ãƒåãŒé•·ã„å ´åˆã€ã‚¨ã‚¤ãƒªã‚¢ã‚¹URLã¯åˆ‡ã‚Šè©°ã‚ã‚‰ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ä¸Šè¨˜ã®URLãŒæ­£ç¢ºãªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã§ã™ã€‚`;
            } else {
              comment += `â³ **ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆé€²è¡Œä¸­**: ${status}\n\n`;
              comment += `ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒå®Œäº†ã—ãŸã‚‰ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚\n\n`;
              comment += `ğŸ“Š [é€²æ—ã‚’ç¢ºèª](${dashboardUrl})`;
            }

            // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸš€ Cloudflare Pages ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒ')
            );

            if (botComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            } else {
              // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: comment
              });
              console.log('æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ');
            }
